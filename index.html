<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arkelis - Configurateur & Admin</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'arkelis-turquoise': '#00B6B6',
                        'arkelis-blue': '#004F4F',
                        'arkelis-light': '#F7F9FA',
                        'arkelis-gray': '#E9F0F1',
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #F7F9FA;
        }
        .card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: all 0.2s;
        }
        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            padding: 10px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00B6B6 0%, #004F4F 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 182, 182, 0.3);
        }
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-monthly {
            background: #D1F5F5;
            color: #00B6B6;
        }
        .badge-unique {
            background: #FFE8D1;
            color: #FF8C42;
        }
        .badge-yearly {
            background: #E9D7FF;
            color: #8B5CF6;
        }
        input[type="number"], input[type="text"], input[type="email"], input[type="date"], select, textarea {
            padding: 10px 14px;
            border: 2px solid #E9F0F1;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #00B6B6;
            box-shadow: 0 0 0 3px rgba(0, 182, 182, 0.1);
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.2s;
            font-weight: 600;
        }
        .tab.active {
            background: #00B6B6;
            color: white;
        }
        .tab:not(.active):hover {
            background: #E9F0F1;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // TVA
        const TVA_RATE = 1.2;

        // Fonction utilitaire pour obtenir le palier de remise
        const getDiscountTier = (qty, discounts) => {
            if (qty > 100) {
                return { rate: null, tierLabel: 'Sur devis', tier: null };
            }
            
            const tier = discounts.find(d => qty >= d.min && qty <= d.max);
            if (!tier) return { rate: 0, tierLabel: 'Aucune remise', tier: null };
            
            return {
                rate: tier.discount,
                tierLabel: tier.discount > 0 ? `Remise de ${tier.discount}%` : 'Prix normal',
                tier: tier
            };
        };

        // Produits par d√©faut avec tarifs HT corrects
        const defaultProducts = [
            { id: 1, name: "Audit", price: 90, type: "unique", category: "Service", description: "Audit de s√©curit√© complet", tags: "s√©curit√©,audit" },
            { id: 2, name: "Honoraire (1h)", price: 90, type: "unique", category: "Service", description: "Consultation d'une heure", tags: "consultation,service" },
            { id: 3, name: "Guide PDF Bitwarden", price: 50, type: "unique", category: "Formation", description: "Guide complet d'utilisation", tags: "formation,guide" },
            { id: 4, name: "Gestionnaire de mot de passe (Bitwarden)", price: 15, type: "monthly", category: "Licence", description: "Par utilisateur et par mois", tags: "bitwarden,licence" },
            { id: 5, name: "Support < 30 min", price: 15, type: "monthly", category: "Support", description: "Support mensuel jusqu'√† 30 minutes", tags: "support" },
            { id: 6, name: "Support < 1 h", price: 10, type: "monthly", category: "Support", description: "Support mensuel jusqu'√† 1 heure", tags: "support" },
        ];

        // D√©penses par d√©faut (depuis ao√ªt 2025)
        const defaultExpenses = [
            { id: 1, description: "Odoo", amount: 30, frequency: "monthly", startDate: "2025-08-01", type: "expense" },
            { id: 2, description: "Bitwarden", amount: 14, frequency: "monthly", startDate: "2025-08-01", type: "expense" },
            { id: 3, description: "Google Workspace", amount: 40, frequency: "monthly", startDate: "2025-08-01", type: "expense" },
            { id: 4, description: "Avocat", amount: 1800, frequency: "unique", startDate: "2025-08-01", type: "expense" },
            { id: 5, description: "Cartes de visite", amount: 41, frequency: "unique", startDate: "2025-08-01", type: "expense" },
            { id: 6, description: "Nom de domaine", amount: 12, frequency: "yearly", startDate: "2025-08-01", type: "expense" },
        ];

        // Grille de remises Bitwarden par d√©faut (base 15‚Ç¨ HT)
        const defaultDiscounts = [
            { min: 1, max: 10, discount: 0, price: 15.00 },
            { min: 11, max: 25, discount: 5, price: 14.25 },
            { min: 26, max: 50, discount: 10, price: 13.50 },
            { min: 51, max: 100, discount: 15, price: 12.75 },
        ];

        // Fonction de calcul de prix avec remises Bitwarden
        const calculatePrice = (basePrice, quantity, discounts) => {
            if (quantity > 100) {
                return { type: 'quote', message: 'Sur devis' };
            }
            
            const tier = discounts.find(d => quantity >= d.min && quantity <= d.max);
            if (!tier) return basePrice * quantity;
            
            const unitPrice = Math.max(tier.price, 12.00); // Plancher de marge ajust√©
            return unitPrice * quantity;
        };

        // Composant principal
        function ArkelisApp() {
            const [route, setRoute] = useState('home');
            const [adminTab, setAdminTab] = useState('products');

            return (
                <div className="min-h-screen">
                    <header className="bg-gradient-to-r from-arkelis-turquoise to-arkelis-blue text-white py-6 shadow-lg">
                        <div className="container mx-auto px-6">
                            <div className="flex justify-between items-center">
                                <button 
                                    onClick={() => setRoute('home')}
                                    className="hover:opacity-80 transition-opacity"
                                >
                                    <h1 className="text-3xl font-bold">Arkelis</h1>
                                    <p className="text-sm opacity-90">Cybers√©curit√© du quotidien</p>
                                </button>
                                {route !== 'home' && (
                                    <button 
                                        onClick={() => setRoute('home')}
                                        className="px-6 py-2 rounded-lg bg-white/20 hover:bg-white/30 transition-all"
                                    >
                                        ‚Üê Retour √† l'accueil
                                    </button>
                                )}
                            </div>
                        </div>
                    </header>

                    <main className="container mx-auto px-6 py-8">
                        {route === 'home' && <HomeView setRoute={setRoute} />}
                        {route === 'simulateur' && <ClientView />}
                        {route === 'admin' && <AdminView activeTab={adminTab} setActiveTab={setAdminTab} />}
                    </main>
                </div>
            );
        }

        // Page d'accueil
        function HomeView({ setRoute }) {
            return (
                <div className="max-w-4xl mx-auto">
                    <div className="text-center mb-12">
                        <h2 className="text-4xl font-bold text-arkelis-blue mb-4">Bienvenue sur Arkelis</h2>
                        <p className="text-xl text-gray-600">Choisissez o√π vous souhaitez aller.</p>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <button
                            id="home-simulateur"
                            onClick={() => setRoute('simulateur')}
                            className="card p-8 text-left hover:scale-105 transition-transform cursor-pointer group"
                            aria-label="Acc√©der au configurateur de prix"
                        >
                            <div className="w-16 h-16 bg-gradient-to-br from-arkelis-turquoise to-arkelis-blue rounded-2xl flex items-center justify-center mb-6 group-hover:shadow-lg transition-shadow">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <h3 className="text-2xl font-bold text-arkelis-blue mb-3 group-hover:text-arkelis-turquoise transition-colors">
                                Acc√©der au configurateur
                            </h3>
                            <p className="text-gray-600">
                                Composez votre offre personnalis√©e et calculez vos co√ªts en temps r√©el avec l'application automatique des remises.
                            </p>
                            <div className="mt-6 flex items-center text-arkelis-turquoise font-semibold">
                                <span>Commencer</span>
                                <svg className="w-5 h-5 ml-2 group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </button>

                        <button
                            id="home-admin"
                            onClick={() => setRoute('admin')}
                            className="card p-8 text-left hover:scale-105 transition-transform cursor-pointer group"
                            aria-label="Acc√©der √† l'espace administrateur"
                        >
                            <div className="w-16 h-16 bg-gradient-to-br from-arkelis-blue to-purple-600 rounded-2xl flex items-center justify-center mb-6 group-hover:shadow-lg transition-shadow">
                                <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            <h3 className="text-2xl font-bold text-arkelis-blue mb-3 group-hover:text-purple-600 transition-colors">
                                Acc√©der √† l'admin
                            </h3>
                            <p className="text-gray-600">
                                G√©rez vos produits, remises, clients et suivez vos b√©n√©fices avec le tableau de bord complet.
                            </p>
                            <div className="mt-6 flex items-center text-purple-600 font-semibold">
                                <span>Se connecter</span>
                                <svg className="w-5 h-5 ml-2 group-hover:translate-x-2 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
                                </svg>
                            </div>
                        </button>
                    </div>
                </div>
            );
        }

        // Vue Client (Simulateur)
        function ClientView() {
            const [products, setProducts] = useState([]);
            const [selectedProducts, setSelectedProducts] = useState([]);
            const [discounts, setDiscounts] = useState(defaultDiscounts);

            useEffect(() => {
                const saved = localStorage.getItem('arkelis-products');
                setProducts(saved ? JSON.parse(saved) : defaultProducts);
                
                const savedDiscounts = localStorage.getItem('arkelis-discounts');
                if (savedDiscounts) {
                    setDiscounts(JSON.parse(savedDiscounts));
                }
            }, []);

            const addProduct = (product) => {
                const existing = selectedProducts.find(p => p.id === product.id);
                if (existing) {
                    setSelectedProducts(selectedProducts.map(p => 
                        p.id === product.id ? { ...p, quantity: p.quantity + 1 } : p
                    ));
                } else {
                    setSelectedProducts([...selectedProducts, { ...product, quantity: 1 }]);
                }
            };

            const updateQuantity = (id, quantity) => {
                if (quantity <= 0) {
                    setSelectedProducts(selectedProducts.filter(p => p.id !== id));
                } else {
                    setSelectedProducts(selectedProducts.map(p => 
                        p.id === id ? { ...p, quantity: parseInt(quantity) || 0 } : p
                    ));
                }
            };

            const removeProduct = (id) => {
                setSelectedProducts(selectedProducts.filter(p => p.id !== id));
            };

            const hasActiveDiscount = () => {
                const bitwardenProducts = selectedProducts.filter(p => 
                    p.name.toLowerCase().includes('bitwarden') || p.name.toLowerCase().includes('gestionnaire')
                );
                if (bitwardenProducts.length === 0) return false;

                const totalQty = bitwardenProducts.reduce((sum, p) => sum + p.quantity, 0);
                if (totalQty > 100) return false;
                
                const tierInfo = getDiscountTier(totalQty, discounts);
                return tierInfo.rate > 0;
            };

            const calculateTotals = () => {
                let firstMonth = 0;
                let monthly = 0;
                let yearly = 0;
                let hasQuote = false;

                selectedProducts.forEach(product => {
                    const isBitwarden = product.name.toLowerCase().includes('bitwarden') || product.name.toLowerCase().includes('gestionnaire');
                    
                    if (isBitwarden) {
                        const totalBitwardenQty = selectedProducts
                            .filter(p => p.name.toLowerCase().includes('bitwarden') || p.name.toLowerCase().includes('gestionnaire'))
                            .reduce((sum, p) => sum + p.quantity, 0);

                        if (totalBitwardenQty > 100) {
                            hasQuote = true;
                            return;
                        }

                        const result = calculatePrice(product.price, product.quantity, discounts);
                        if (result.type === 'quote') {
                            hasQuote = true;
                            return;
                        }

                        const cost = result;
                        firstMonth += cost;
                        monthly += cost;
                        yearly += cost * 12;
                    } else {
                        const cost = product.price * product.quantity;
                        
                        if (product.type === 'unique') {
                            firstMonth += cost;
                            yearly += cost;
                        } else if (product.type === 'monthly') {
                            firstMonth += cost;
                            monthly += cost;
                            yearly += cost * 12;
                        } else if (product.type === 'yearly') {
                            firstMonth += cost;
                            yearly += cost;
                        }
                    }
                });

                return { firstMonth, monthly, yearly, hasQuote };
            };

            const totals = calculateTotals();

            return (
                <div>
                    <div className="mb-8">
                        <h2 className="text-3xl font-bold text-arkelis-blue mb-2">Configurateur de prix</h2>
                        <p className="text-gray-600">Composez votre offre et calculez vos co√ªts en temps r√©el</p>
                    </div>

                    {hasActiveDiscount() && (
                        <div id="discount-banner" className="mb-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200 flex items-center gap-3 animate-fadeIn">
                            <span className="text-2xl">üí°</span>
                            <p className="text-sm font-medium text-blue-800">
                                Une remise est appliqu√©e automatiquement selon le nombre de licences.
                            </p>
                        </div>
                    )}

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="lg:col-span-2">
                            <div className="card p-6">
                                <h3 className="text-xl font-bold text-arkelis-blue mb-4">S√©lectionnez vos produits</h3>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {products.map(product => (
                                        <div key={product.id} className="card p-4 border-2 border-arkelis-gray hover:border-arkelis-turquoise cursor-pointer"
                                             onClick={() => addProduct(product)}>
                                            <div className="flex justify-between items-start mb-2">
                                                <div className="flex-1">
                                                    <h4 className="font-semibold text-arkelis-blue">{product.name}</h4>
                                                    <p className="text-sm text-gray-500">{product.category}</p>
                                                </div>
                                                <span className={`badge ${
                                                    product.type === 'monthly' ? 'badge-monthly' :
                                                    product.type === 'unique' ? 'badge-unique' : 'badge-yearly'
                                                }`}>
                                                    {product.type === 'monthly' ? 'Mensuel' :
                                                     product.type === 'unique' ? 'Unique' : 'Annuel'}
                                                </span>
                                            </div>
                                            {product.description && (
                                                <p className="text-xs text-gray-500 mb-3">{product.description}</p>
                                            )}
                                            <div>
                                                <div className="text-2xl font-bold text-arkelis-turquoise">
                                                    {product.price.toFixed(2)} ‚Ç¨ HT
                                                </div>
                                                <div className="text-sm text-gray-600">
                                                    {(product.price * TVA_RATE).toFixed(2)} ‚Ç¨ TTC
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>

                        <div>
                            <div className="card p-6 sticky top-6">
                                <h3 className="text-xl font-bold text-arkelis-blue mb-4">Votre configuration</h3>
                                
                                {selectedProducts.length === 0 ? (
                                    <p className="text-gray-500 text-center py-8">S√©lectionnez des produits pour commencer</p>
                                ) : (
                                    <>
                                        <div className="space-y-3 mb-6 max-h-64 overflow-y-auto">
                                            {selectedProducts.map(product => {
                                                const isBitwarden = product.name.toLowerCase().includes('bitwarden') || product.name.toLowerCase().includes('gestionnaire');
                                                const totalBitwardenQty = isBitwarden ? 
                                                    selectedProducts
                                                        .filter(p => p.name.toLowerCase().includes('bitwarden') || p.name.toLowerCase().includes('gestionnaire'))
                                                        .reduce((sum, p) => sum + p.quantity, 0) : 0;
                                                
                                                const isQuote = isBitwarden && totalBitwardenQty > 100;

                                                return (
                                                    <div key={product.id} className="flex items-center gap-2 p-2 bg-arkelis-light rounded-lg">
                                                        <input 
                                                            type="number" 
                                                            value={product.quantity}
                                                            onChange={(e) => updateQuantity(product.id, e.target.value)}
                                                            className="w-16 text-center"
                                                            min="1"
                                                        />
                                                        <div className="flex-1 min-w-0">
                                                            <p className="text-sm font-semibold truncate">{product.name}</p>
                                                            {isQuote ? (
                                                                <p className="text-xs text-orange-600 font-semibold">Sur devis</p>
                                                            ) : (
                                                                <p className="text-xs text-gray-500">
                                                                    {isBitwarden ? 
                                                                        `${(calculatePrice(product.price, product.quantity, discounts) / product.quantity).toFixed(2)} ‚Ç¨ √ó ${product.quantity}` :
                                                                        `${product.price.toFixed(2)} ‚Ç¨ √ó ${product.quantity}`
                                                                    }
                                                                </p>
                                                            )}
                                                        </div>
                                                        <button 
                                                            onClick={() => removeProduct(product.id)}
                                                            className="text-red-500 hover:text-red-700 font-bold"
                                                        >
                                                            ‚úï
                                                        </button>
                                                    </div>
                                                );
                                            })}
                                        </div>

                                        <div className="border-t-2 border-arkelis-gray pt-4 space-y-3">
                                            <div className="flex justify-between">
                                                <span className="font-semibold">Premier mois</span>
                                                <span className="text-xl font-bold text-arkelis-turquoise">
                                                    {totals.firstMonth.toFixed(2)} ‚Ç¨ HT
                                                </span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="font-semibold">Mensuel r√©current</span>
                                                <span className="text-xl font-bold text-arkelis-turquoise">
                                                    {totals.monthly.toFixed(2)} ‚Ç¨ HT
                                                </span>
                                            </div>
                                            <div className="flex justify-between">
                                                <span className="font-semibold">Total annuel</span>
                                                <span className="text-xl font-bold text-arkelis-turquoise">
                                                    {totals.yearly.toFixed(2)} ‚Ç¨ HT
                                                </span>
                                            </div>

                                            {totals.hasQuote && (
                                                <div className="mt-4 p-4 bg-orange-50 rounded-lg border-2 border-orange-200">
                                                    <p className="text-sm font-semibold text-orange-800 mb-2">
                                                        üîî Tarif sur devis
                                                    </p>
                                                    <p className="text-xs text-orange-700 mb-3">
                                                        Tarif sur devis ‚Äì contactez-nous pour une offre personnalis√©e.
                                                    </p>
                                                    <a 
                                                        id="cta-devis"
                                                        href="https://www.arkelis-net.com/contactus" 
                                                        target="_blank"
                                                        rel="noreferrer"
                                                        className="btn btn-primary w-full text-center block"
                                                        aria-label="Demander un devis pour plus de 100 licences"
                                                    >
                                                        Demander un devis
                                                    </a>
                                                </div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Vue Admin
        function AdminView({ activeTab, setActiveTab }) {
            const tabs = [
                { id: 'products', label: 'Gestion des produits' },
                { id: 'discounts', label: 'Gestion des remises' },
                { id: 'clients', label: 'Gestion des clients' },
                { id: 'configurator', label: 'Configurateur Admin' },
                { id: 'benefits', label: 'Calculateur de b√©n√©fices' },
            ];

            return (
                <div>
                    <div className="flex gap-2 mb-6 overflow-x-auto">
                        {tabs.map(tab => (
                            <button
                                key={tab.id}
                                className={`tab ${activeTab === tab.id ? 'active' : ''}`}
                                onClick={() => setActiveTab(tab.id)}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {activeTab === 'products' && <ProductManagement />}
                    {activeTab === 'discounts' && <DiscountManagement />}
                    {activeTab === 'clients' && <ClientManagement />}
                    {activeTab === 'configurator' && <AdminConfigurator />}
                    {activeTab === 'benefits' && <BenefitsCalculator />}
                </div>
            );
        }

        // Gestion des produits avec CRUD complet
        function ProductManagement() {
            const [products, setProducts] = useState([]);
            const [editingProduct, setEditingProduct] = useState(null);
            const [formData, setFormData] = useState({
                name: '', price: 0, type: 'monthly', category: '', description: '', tags: ''
            });

            useEffect(() => {
                const saved = localStorage.getItem('arkelis-products');
                setProducts(saved ? JSON.parse(saved) : defaultProducts);
            }, []);

            useEffect(() => {
                localStorage.setItem('arkelis-products', JSON.stringify(products));
            }, [products]);

            const handleSubmit = () => {
                if (!formData.name || formData.price < 0 || !formData.type || !formData.category) {
                    alert('Veuillez remplir tous les champs obligatoires (nom, prix ‚â• 0, type, cat√©gorie)');
                    return;
                }

                if (editingProduct) {
                    setProducts(products.map(p => 
                        p.id === editingProduct.id ? { ...formData, id: editingProduct.id, price: parseFloat(formData.price) } : p
                    ));
                    setEditingProduct(null);
                } else {
                    setProducts([...products, { ...formData, id: Date.now(), price: parseFloat(formData.price) }]);
                }
                
                setFormData({ name: '', price: 0, type: 'monthly', category: '', description: '', tags: '' });
            };

            const handleEdit = (product) => {
                setEditingProduct(product);
                setFormData(product);
            };

            const handleDelete = (id) => {
                if (confirm('Supprimer ce produit ?')) {
                    setProducts(products.filter(p => p.id !== id));
                }
            };

            const handleCancel = () => {
                setEditingProduct(null);
                setFormData({ name: '', price: 0, type: 'monthly', category: '', description: '', tags: '' });
            };

            return (
                <div>
                    <h2 className="text-2xl font-bold text-arkelis-blue mb-6">Gestion des produits (CRUD)</h2>
                    
                    <div className="card p-6 mb-6">
                        <h3 className="text-lg font-bold text-arkelis-blue mb-4">
                            {editingProduct ? 'Modifier le produit' : 'Ajouter un produit'}
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <input
                                type="text"
                                placeholder="Nom du produit *"
                                value={formData.name}
                                onChange={(e) => setFormData({...formData, name: e.target.value})}
                                className="w-full"
                            />
                            <input
                                type="number"
                                placeholder="Prix HT *"
                                value={formData.price}
                                onChange={(e) => setFormData({...formData, price: e.target.value})}
                                className="w-full"
                                min="0"
                                step="0.01"
                            />
                            <select
                                value={formData.type}
                                onChange={(e) => setFormData({...formData, type: e.target.value})}
                                className="w-full"
                            >
                                <option value="monthly">Mensuel</option>
                                <option value="unique">Unique</option>
                                <option value="yearly">Annuel</option>
                            </select>
                            <input
                                type="text"
                                placeholder="Cat√©gorie *"
                                value={formData.category}
                                onChange={(e) => setFormData({...formData, category: e.target.value})}
                                className="w-full"
                            />
                            <input
                                type="text"
                                placeholder="Tags (s√©par√©s par virgules)"
                                value={formData.tags}
                                onChange={(e) => setFormData({...formData, tags: e.target.value})}
                                className="w-full"
                            />
                            <textarea
                                placeholder="Description"
                                value={formData.description}
                                onChange={(e) => setFormData({...formData, description: e.target.value})}
                                className="w-full md:col-span-2"
                            />
                        </div>
                        <div className="flex gap-3">
                            <button onClick={handleSubmit} className="btn btn-primary">
                                {editingProduct ? 'Mettre √† jour' : 'Ajouter'}
                            </button>
                            {editingProduct && (
                                <button onClick={handleCancel} className="btn bg-gray-200 text-gray-700">
                                    Annuler
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="card p-6">
                        <h3 className="text-lg font-bold text-arkelis-blue mb-4">Produits existants ({products.length})</h3>
                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-arkelis-light">
                                    <tr>
                                        <th className="p-3 text-left">Nom</th>
                                        <th className="p-3 text-left">Prix HT</th>
                                        <th className="p-3 text-left">Prix TTC</th>
                                        <th className="p-3 text-left">Type</th>
                                        <th className="p-3 text-left">Cat√©gorie</th>
                                        <th className="p-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {products.map((product, index) => (
                                        <tr key={product.id} className={index % 2 === 0 ? 'bg-white' : 'bg-arkelis-light'}>
                                            <td className="p-3">
                                                <div>
                                                    <div className="font-semibold">{product.name}</div>
                                                    {product.description && (
                                                        <div className="text-xs text-gray-500">{product.description}</div>
                                                    )}
                                                </div>
                                            </td>
                                            <td className="p-3 font-bold text-arkelis-turquoise">{product.price.toFixed(2)} ‚Ç¨</td>
                                            <td className="p-3 text-gray-600">{(product.price * TVA_RATE).toFixed(2)} ‚Ç¨</td>
                                            <td className="p-3">
                                                <span className={`badge ${
                                                    product.type === 'monthly' ? 'badge-monthly' :
                                                    product.type === 'unique' ? 'badge-unique' : 'badge-yearly'
                                                }`}>
                                                    {product.type === 'monthly' ? 'Mensuel' :
                                                     product.type === 'unique' ? 'Unique' : 'Annuel'}
                                                </span>
                                            </td>
                                            <td className="p-3">{product.category}</td>
                                            <td className="p-3 text-center">
                                                <button 
                                                    onClick={() => handleEdit(product)}
                                                    className="text-blue-500 hover:text-blue-700 font-semibold mr-3"
                                                >
                                                    Modifier
                                                </button>
                                                <button 
                                                    onClick={() => handleDelete(product.id)}
                                                    className="text-red-500 hover:text-red-700 font-semibold"
                                                >
                                                    Supprimer
                                                </button>
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            );
        }

        // Gestion des remises (identique √† avant avec nouveau prix de base)
        function DiscountManagement() {
            const [discounts, setDiscounts] = useState(defaultDiscounts);
            const [mode, setMode] = useState('default');

            useEffect(() => {
                const saved = localStorage.getItem('arkelis-discounts');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    setDiscounts(parsed);
                    setMode('custom');
                } else {
                    setDiscounts(defaultDiscounts);
                }
            }, []);

            useEffect(() => {
                if (mode === 'custom') {
                    localStorage.setItem('arkelis-discounts', JSON.stringify(discounts));
                } else {
                    localStorage.removeItem('arkelis-discounts');
                }
            }, [discounts, mode]);

            const updateDiscount = (index, field, value) => {
                const updated = [...discounts];
                updated[index] = {
                    ...updated[index],
                    [field]: field === 'discount' ? parseFloat(value) : value
                };
                
                if (field === 'discount') {
                    const basePrice = 15;
                    updated[index].price = Math.max(basePrice * (1 - updated[index].discount / 100), 12.00);
                }
                
                setDiscounts(updated);
                setMode('custom');
            };

            const resetToDefault = () => {
                if (confirm('R√©initialiser aux remises par d√©faut ?')) {
                    setDiscounts(defaultDiscounts);
                    setMode('default');
                    localStorage.removeItem('arkelis-discounts');
                }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-arkelis-blue">Gestion des remises Bitwarden</h2>
                        <button onClick={resetToDefault} className="btn bg-gray-200 text-gray-700 hover:bg-gray-300">
                            R√©initialiser
                        </button>
                    </div>

                    <div className="card p-6">
                        <div className="mb-4">
                            <span className={`badge ${mode === 'default' ? 'badge-monthly' : 'badge-unique'}`}>
                                {mode === 'default' ? 'Grille par d√©faut' : 'Grille personnalis√©e'}
                            </span>
                        </div>

                        <div className="overflow-x-auto">
                            <table className="w-full">
                                <thead className="bg-arkelis-light">
                                    <tr>
                                        <th className="p-3 text-left">Nombre d'utilisateurs</th>
                                        <th className="p-3 text-left">Remise (%)</th>
                                        <th className="p-3 text-left">Prix unitaire HT</th>
                                        <th className="p-3 text-left">Prix unitaire TTC</th>
                                        <th className="p-3 text-left">Comportement</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {discounts.map((discount, index) => (
                                        <tr key={index} className={index % 2 === 0 ? 'bg-white' : 'bg-arkelis-light'}>
                                            <td className="p-3 font-semibold">
                                                {discount.min} ‚Äì {discount.max}
                                            </td>
                                            <td className="p-3">
                                                <input
                                                    type="number"
                                                    value={discount.discount}
                                                    onChange={(e) => updateDiscount(index, 'discount', e.target.value)}
                                                    className="w-24"
                                                    min="0"
                                                    max="100"
                                                    step="1"
                                                />
                                            </td>
                                            <td className="p-3 font-bold text-arkelis-turquoise">
                                                {discount.price.toFixed(2)} ‚Ç¨
                                            </td>
                                            <td className="p-3 text-gray-600">
                                                {(discount.price * TVA_RATE).toFixed(2)} ‚Ç¨
                                            </td>
                                            <td className="p-3">
                                                {discount.discount > 0 ? (
                                                    <span className="badge badge-monthly">Remise appliqu√©e</span>
                                                ) : (
                                                    <span className="badge badge-unique">Prix normal</span>
                                                )}
                                            </td>
                                        </tr>
                                    ))}
                                    <tr className="bg-orange-50">
                                        <td className="p-3 font-semibold">> 100</td>
                                        <td className="p-3">‚Äî</td>
                                        <td className="p-3">‚Äî</td>
                                        <td className="p-3">‚Äî</td>
                                        <td className="p-3">
                                            <span className="badge badge-yearly">Sur devis</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div className="mt-6 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
                            <p className="text-sm text-blue-800">
                                <strong>üí° Note :</strong> Le plancher de marge est fix√© √† 12,00 ‚Ç¨ HT. 
                                Les remises ne peuvent pas faire descendre le prix en dessous de ce seuil.
                            </p>
                        </div>
                    </div>
                </div>
            );
        }

        // Gestion des clients (NOUVEAU MODULE)
        function ClientManagement() {
            const [clients, setClients] = useState([]);
            const [products, setProducts] = useState([]);
            const [discounts, setDiscounts] = useState(defaultDiscounts);
            const [showForm, setShowForm] = useState(false);

            useEffect(() => {
                const savedClients = localStorage.getItem('arkelis-clients');
                if (savedClients) setClients(JSON.parse(savedClients));

                const savedProducts = localStorage.getItem('arkelis-products');
                setProducts(savedProducts ? JSON.parse(savedProducts) : defaultProducts);

                const savedDiscounts = localStorage.getItem('arkelis-discounts');
                if (savedDiscounts) setDiscounts(JSON.parse(savedDiscounts));
            }, []);

            useEffect(() => {
                localStorage.setItem('arkelis-clients', JSON.stringify(clients));
            }, [clients]);

            const addClient = (client) => {
                setClients([...clients, { ...client, id: Date.now(), createdAt: new Date().toISOString() }]);
                setShowForm(false);
            };

            const deleteClient = (id) => {
                if (confirm('Supprimer ce client ?')) {
                    setClients(clients.filter(c => c.id !== id));
                }
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-2xl font-bold text-arkelis-blue">Gestion des clients</h2>
                        <button 
                            onClick={() => setShowForm(!showForm)}
                            className="btn btn-primary"
                        >
                            {showForm ? 'Annuler' : '+ Nouveau client'}
                        </button>
                    </div>

                    {showForm && (
                        <ClientForm 
                            products={products}
                            discounts={discounts}
                            onSave={addClient}
                            onCancel={() => setShowForm(false)}
                        />
                    )}

                    <div className="card p-6">
                        <h3 className="text-lg font-bold text-arkelis-blue mb-4">Clients ({clients.length})</h3>
                        
                        {clients.length === 0 ? (
                            <p className="text-gray-500 text-center py-8">Aucun client enregistr√©</p>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead className="bg-arkelis-light">
                                        <tr>
                                            <th className="p-3 text-left">Client</th>
                                            <th className="p-3 text-left">Initial HT</th>
                                            <th className="p-3 text-left">Initial TTC</th>
                                            <th className="p-3 text-left">Mensuel HT</th>
                                            <th className="p-3 text-left">Mensuel TTC</th>
                                            <th className="p-3 text-left">D√©but</th>
                                            <th className="p-3 text-left">Statut</th>
                                            <th className="p-3 text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {clients.map((client, index) => {
                                            const totals = calculateClientTotals(client, products, discounts);
                                            return (
                                                <tr key={client.id} className={index % 2 === 0 ? 'bg-white' : 'bg-arkelis-light'}>
                                                    <td className="p-3">
                                                        <div className="font-semibold">{client.name}</div>
                                                        <div className="text-xs text-gray-500">{client.email}</div>
                                                    </td>
                                                    <td className="p-3 font-bold text-arkelis-turquoise">{totals.initialHT.toFixed(2)} ‚Ç¨</td>
                                                    <td className="p-3 text-gray-600">{totals.initialTTC.toFixed(2)} ‚Ç¨</td>
                                                    <td className="p-3 font-bold text-arkelis-turquoise">{totals.monthlyHT.toFixed(2)} ‚Ç¨</td>
                                                    <td className="p-3 text-gray-600">{totals.monthlyTTC.toFixed(2)} ‚Ç¨</td>
                                                    <td className="p-3">{new Date(client.startDate).toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' })}</td>
                                                    <td className="p-3">
                                                        <span className={`badge ${client.status === 'active' ? 'badge-monthly' : 'badge-unique'}`}>
                                                            {client.status === 'active' ? 'Actif' : 'Inactif'}
                                                        </span>
                                                    </td>
                                                    <td className="p-3 text-center">
                                                        <button 
                                                            onClick={() => deleteClient(client.id)}
                                                            className="text-red-500 hover:text-red-700 font-semibold"
                                                        >
                                                            Supprimer
                                                        </button>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Calcul des totaux pour un client
        function calculateClientTotals(client, products, discounts) {
            let initialHT = 0;
            let monthlyHT = 0;

            if (!client.products) return { initialHT: 0, initialTTC: 0, monthlyHT: 0, monthlyTTC: 0 };

            client.products.forEach(item => {
                const product = products.find(p => p.id === item.productId);
                if (!product) return;

                const isBitwarden = product.name.toLowerCase().includes('bitwarden') || product.name.toLowerCase().includes('gestionnaire');
                let cost = product.price * item.quantity;

                if (isBitwarden) {
                    const totalBitwardenQty = client.products
                        .filter(p => {
                            const prod = products.find(pr => pr.id === p.productId);
                            return prod && (prod.name.toLowerCase().includes('bitwarden') || prod.name.toLowerCase().includes('gestionnaire'));
                        })
                        .reduce((sum, p) => sum + p.quantity, 0);

                    if (totalBitwardenQty <= 100) {
                        cost = calculatePrice(product.price, item.quantity, discounts);
                    } else {
                        return; // Sur devis, non compt√©
                    }
                }

                if (item.initialFees) {
                    initialHT += parseFloat(item.initialFees);
                }

                if (product.type === 'monthly') {
                    monthlyHT += cost;
                } else if (product.type === 'yearly') {
                    monthlyHT += cost / 12;
                } else if (product.type === 'unique') {
                    initialHT += cost;
                }
            });

            return {
                initialHT,
                initialTTC: initialHT * TVA_RATE,
                monthlyHT,
                monthlyTTC: monthlyHT * TVA_RATE
            };
        }

        // Formulaire client (suite au prochain message car limite de caract√®res)
        function ClientForm({ products, discounts, onSave, onCancel }) {
            const [client, setClient] = useState({
                name: '',
                email: '',
                startDate: new Date().toISOString().split('T')[0],
                status: 'active',
                products: []
            });

            const [selectedProduct, setSelectedProduct] = useState(null);
            const [productQty, setProductQty] = useState(1);
            const [initialFees, setInitialFees] = useState(0);

            const addProductToClient = () => {
                if (!selectedProduct) return;

                const product = products.find(p => p.id === parseInt(selectedProduct));
                if (!product) return;

                const newProduct = {
                    productId: product.id,
                    quantity: productQty,
                    initialFees: parseFloat(initialFees) || 0,
                    contractedPrice: product.price // Prix au moment du contrat
                };

                setClient({
                    ...client,
                    products: [...client.products, newProduct]
                });

                setSelectedProduct(null);
                setProductQty(1);
                setInitialFees(0);
            };

            const removeProduct = (index) => {
                setClient({
                    ...client,
                    products: client.products.filter((_, i) => i !== index)
                });
            };

            return (
                <div className="card p-6 mb-6">
                    <h4 className="font-bold text-arkelis-blue mb-4">Nouveau client</h4>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <input
                            type="text"
                            placeholder="Raison sociale *"
                            value={client.name}
                            onChange={(e) => setClient({...client, name: e.target.value})}
                            className="w-full"
                        />
                        <input
                            type="email"
                            placeholder="Email de contact *"
                            value={client.email}
                            onChange={(e) => setClient({...client, email: e.target.value})}
                            className="w-full"
                        />
                        <input
                            type="date"
                            value={client.startDate}
                            onChange={(e) => setClient({...client, startDate: e.target.value})}
                            className="w-full"
                        />
                        <select
                            value={client.status}
                            onChange={(e) => setClient({...client, status: e.target.value})}
                            className="w-full"
                        >
                            <option value="active">Actif</option>
                            <option value="inactive">Inactif</option>
                        </select>
                    </div>

                    <div className="border-t-2 border-arkelis-gray pt-4 mb-4">
                        <h5 className="font-semibold mb-3">Produits factur√©s</h5>
                        <div className="grid grid-cols-4 gap-2 mb-3">
                            <select
                                value={selectedProduct || ''}
                                onChange={(e) => setSelectedProduct(e.target.value)}
                                className="col-span-2"
                            >
                                <option value="">Choisir un produit</option>
                                {products.map(p => (
                                    <option key={p.id} value={p.id}>
                                        {p.name} - {p.price.toFixed(2)}‚Ç¨ HT ({p.type})
                                    </option>
                                ))}
                            </select>
                            <input
                                type="number"
                                placeholder="Quantit√©"
                                value={productQty}
                                onChange={(e) => setProductQty(parseInt(e.target.value) || 1)}
                                className="w-full"
                                min="1"
                            />
                            <button onClick={addProductToClient} className="btn btn-primary text-sm">
                                Ajouter
                            </button>
                        </div>

                        <div className="mb-3">
                            <input
                                type="number"
                                placeholder="Frais initiaux (optionnel)"
                                value={initialFees}
                                onChange={(e) => setInitialFees(e.target.value)}
                                className="w-full"
                                min="0"
                                step="0.01"
                            />
                        </div>

                        {client.products.length > 0 && (
                            <div className="space-y-2">
                                {client.products.map((item, index) => {
                                    const product = products.find(p => p.id === item.productId);
                                    if (!product) return null;

                                    return (
                                        <div key={index} className="flex items-center gap-2 p-2 bg-arkelis-light rounded-lg text-sm">
                                            <span className="flex-1">
                                                {product.name} √ó {item.quantity} ({product.type})
                                                {item.initialFees > 0 && ` + ${item.initialFees.toFixed(2)}‚Ç¨ frais`}
                                            </span>
                                            <button 
                                                onClick={() => removeProduct(index)}
                                                className="text-red-500 hover:text-red-700 font-bold"
                                            >
                                                ‚úï
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                    </div>

                    <div className="flex gap-3">
                        <button 
                            onClick={() => {
                                if (!client.name || !client.email || client.products.length === 0) {
                                    alert('Veuillez remplir tous les champs obligatoires et ajouter au moins un produit');
                                    return;
                                }
                                onSave(client);
                            }}
                            className="btn btn-primary flex-1"
                        >
                            Enregistrer le client
                        </button>
                        <button onClick={onCancel} className="btn bg-gray-200 text-gray-700">
                            Annuler
                        </button>
                    </div>
                </div>
            );
        }

        // Configurateur Admin (simplifi√©, identique au client)
        function AdminConfigurator() {
            return (
                <div>
                    <h2 className="text-2xl font-bold text-arkelis-blue mb-4">Configurateur Admin</h2>
                    <p className="text-gray-600 mb-6">
                        Utilisez le simulateur client pour les simulations internes (m√™me logique, m√™mes produits).
                    </p>
                    <div className="card p-8 text-center">
                        <p className="text-gray-500">
                            Ce module utilise les m√™mes donn√©es que le configurateur client.
                            Toutes les modifications de produits et remises sont imm√©diatement actives.
                        </p>
                    </div>
                </div>
            );
        }

        // Calculateur de b√©n√©fices AM√âLIOR√â
        function BenefitsCalculator() {
            const [clients, setClients] = useState([]);
            const [expenses, setExpenses] = useState(defaultExpenses);
            const [products, setProducts] = useState([]);
            const [discounts, setDiscounts] = useState(defaultDiscounts);
            const [showExpenseForm, setShowExpenseForm] = useState(false);
            const chartRef = useRef(null);
            const chartInstance = useRef(null);

            useEffect(() => {
                const savedClients = localStorage.getItem('arkelis-clients');
                if (savedClients) setClients(JSON.parse(savedClients));

                const savedExpenses = localStorage.getItem('arkelis-expenses');
                const loadedExpenses = savedExpenses ? JSON.parse(savedExpenses) : [];
                
                const mergedExpenses = [...defaultExpenses];
                loadedExpenses.forEach(expense => {
                    if (!defaultExpenses.find(d => d.description === expense.description)) {
                        mergedExpenses.push(expense);
                    }
                });
                setExpenses(mergedExpenses);

                const savedProducts = localStorage.getItem('arkelis-products');
                setProducts(savedProducts ? JSON.parse(savedProducts) : defaultProducts);

                const savedDiscounts = localStorage.getItem('arkelis-discounts');
                if (savedDiscounts) setDiscounts(JSON.parse(savedDiscounts));
            }, []);

            useEffect(() => {
                const nonDefaultExpenses = expenses.filter(e => 
                    !defaultExpenses.find(d => d.description === e.description)
                );
                localStorage.setItem('arkelis-expenses', JSON.stringify(nonDefaultExpenses));
            }, [expenses]);

            // Calcul des cumuls depuis ao√ªt 2025
            const calculateCumulatives = () => {
                const startDate = new Date('2025-08-01');
                const now = new Date();
                const monthsSinceStart = Math.max(0, (now.getFullYear() - startDate.getFullYear()) * 12 + now.getMonth() - startDate.getMonth() + 1);

                // D√©penses cumul√©es
                let cumulativeExpenses = 0;
                expenses.forEach(exp => {
                    if (exp.frequency === 'unique') {
                        cumulativeExpenses += exp.amount;
                    } else if (exp.frequency === 'monthly') {
                        cumulativeExpenses += exp.amount * monthsSinceStart;
                    } else if (exp.frequency === 'yearly') {
                        const yearsElapsed = monthsSinceStart / 12;
                        cumulativeExpenses += exp.amount * Math.floor(yearsElapsed);
                    }
                });

                // Revenus cumul√©s
                let cumulativeRevenue = 0;
                let currentMRR = 0;

                clients.forEach(client => {
                    if (client.status !== 'active') return;

                    const clientTotals = calculateClientTotals(client, products, discounts);
                    const clientStart = new Date(client.startDate);
                    
                    if (clientStart <= now) {
                        const clientMonths = Math.max(0, (now.getFullYear() - clientStart.getFullYear()) * 12 + now.getMonth() - clientStart.getMonth() + 1);
                        cumulativeRevenue += clientTotals.initialHT + (clientTotals.monthlyHT * clientMonths);
                        currentMRR += clientTotals.monthlyHT;
                    }
                });

                // Burn rate mensuel (r√©currentes uniquement)
                const burnRate = expenses
                    .filter(e => e.frequency === 'monthly')
                    .reduce((sum, e) => sum + e.amount, 0) +
                    expenses
                    .filter(e => e.frequency === 'yearly')
                    .reduce((sum, e) => sum + (e.amount / 12), 0);

                // Point d'√©quilibre (payback)
                let paybackMonth = null;
                let cumulRev = 0;
                let cumulExp = 0;

                for (let m = 0; m <= 24; m++) {
                    const monthDate = new Date(startDate);
                    monthDate.setMonth(monthDate.getMonth() + m);

                    // Calculer revenus du mois
                    clients.forEach(client => {
                        if (client.status !== 'active') return;
                        const clientStart = new Date(client.startDate);
                        const clientTotals = calculateClientTotals(client, products, discounts);

                        if (clientStart.getTime() === monthDate.getTime()) {
                            cumulRev += clientTotals.initialHT;
                        }
                        if (clientStart <= monthDate) {
                            cumulRev += clientTotals.monthlyHT;
                        }
                    });

                    // Calculer d√©penses du mois
                    expenses.forEach(exp => {
                        const expStart = new Date(exp.startDate);
                        if (expStart.getTime() === monthDate.getTime() && exp.frequency === 'unique') {
                            cumulExp += exp.amount;
                        }
                        if (expStart <= monthDate && exp.frequency === 'monthly') {
                            cumulExp += exp.amount;
                        }
                        if (expStart <= monthDate && exp.frequency === 'yearly' && monthDate.getMonth() === expStart.getMonth()) {
                            cumulExp += exp.amount;
                        }
                    });

                    if (cumulRev >= cumulExp && !paybackMonth) {
                        paybackMonth = monthDate.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
                    }
                }

                return {
                    cumulativeExpenses,
                    cumulativeRevenue,
                    burnRate,
                    paybackMonth: paybackMonth || 'Non atteint',
                    currentMRR,
                    currentARR: currentMRR * 12
                };
            };

            const stats = calculateCumulatives();

            // Graphique
            useEffect(() => {
                if (chartRef.current) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const ctx = chartRef.current.getContext('2d');
                    const monthlyData = [];
                    
                    for (let i = 0; i < 12; i++) {
                        monthlyData.push(stats.currentMRR - stats.burnRate);
                    }

                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'F√©v', 'Mar', 'Avr', 'Mai', 'Jun', 'Jul', 'Ao√ª', 'Sep', 'Oct', 'Nov', 'D√©c'],
                            datasets: [{
                                label: 'B√©n√©fice mensuel pr√©vu (‚Ç¨ HT)',
                                data: monthlyData,
                                backgroundColor: '#00B6B6',
                                borderRadius: 8,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' ‚Ç¨';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [stats]);

            return (
                <div>
                    <h2 className="text-2xl font-bold text-arkelis-blue mb-6">Calculateur de b√©n√©fices</h2>
                    <p className="text-sm text-gray-600 mb-6">Point de d√©part comptable : ao√ªt 2025</p>

                    {/* Indicateurs principaux */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div className="card p-6 bg-gradient-to-br from-red-50 to-red-100">
                            <p className="text-sm text-gray-600 mb-1">D√©penses cumul√©es</p>
                            <p className="text-xs text-gray-500 mb-2">Depuis 08/2025</p>
                            <p className="text-3xl font-bold text-red-600">{stats.cumulativeExpenses.toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div className="card p-6 bg-gradient-to-br from-orange-50 to-orange-100">
                            <p className="text-sm text-gray-600 mb-1">Burn rate mensuel</p>
                            <p className="text-xs text-gray-500 mb-2">Charges r√©currentes</p>
                            <p className="text-3xl font-bold text-orange-600">{stats.burnRate.toFixed(2)} ‚Ç¨</p>
                        </div>
                        <div className="card p-6 bg-gradient-to-br from-blue-50 to-blue-100">
                            <p className="text-sm text-gray-600 mb-1">Point d'√©quilibre</p>
                            <p className="text-xs text-gray-500 mb-2">Atteint le</p>
                            <p className="text-2xl font-bold text-blue-600">{stats.paybackMonth}</p>
                        </div>
                    </div>

                    {/* KPIs revenus */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <div className="card p-6 bg-gradient-to-br from-green-50 to-green-100">
                            <p className="text-sm text-gray-600 mb-1">Revenus cumul√©s</p>
                            <p className="text-3xl font-bold text-green-600">{stats.cumulativeRevenue.toFixed(2)} ‚Ç¨</p>
                            <p className="text-xs text-gray-500">Depuis 08/2025</p>
                        </div>
                        <div className="card p-6 bg-gradient-to-br from-teal-50 to-teal-100">
                            <p className="text-sm text-gray-600 mb-1">MRR</p>
                            <p className="text-3xl font-bold text-teal-600">{stats.currentMRR.toFixed(2)} ‚Ç¨</p>
                            <p className="text-xs text-gray-500">Revenus mensuels r√©currents</p>
                        </div>
                        <div className="card p-6 bg-gradient-to-br from-cyan-50 to-cyan-100">
                            <p className="text-sm text-gray-600 mb-1">ARR</p>
                            <p className="text-3xl font-bold text-cyan-600">{stats.currentARR.toFixed(2)} ‚Ç¨</p>
                            <p className="text-xs text-gray-500">Revenus annuels r√©currents</p>
                        </div>
                        <div className="card p-6 bg-gradient-to-br from-purple-50 to-purple-100">
                            <p className="text-sm text-gray-600 mb-1">B√©n√©fice mensuel</p>
                            <p className="text-3xl font-bold text-purple-600">{(stats.currentMRR - stats.burnRate).toFixed(2)} ‚Ç¨</p>
                            <p className="text-xs text-gray-500">MRR - Burn rate</p>
                        </div>
                    </div>

                    {/* Graphique */}
                    <div className="card p-6 mb-8">
                        <h3 className="text-lg font-bold text-arkelis-blue mb-4">Projection des b√©n√©fices mensuels</h3>
                        <div style={{ height: '300px' }}>
                            <canvas ref={chartRef}></canvas>
                        </div>
                    </div>

                    {/* Gestion des d√©penses */}
                    <div>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-xl font-bold text-arkelis-blue">D√©penses</h3>
                            <button 
                                onClick={() => setShowExpenseForm(!showExpenseForm)}
                                className="btn btn-primary"
                            >
                                {showExpenseForm ? 'Annuler' : '+ Nouvelle d√©pense'}
                            </button>
                        </div>

                        {showExpenseForm && (
                            <ExpenseForm 
                                onSave={(expense) => {
                                    setExpenses([...expenses, { ...expense, id: Date.now(), type: 'expense' }]);
                                    setShowExpenseForm(false);
                                }}
                                onCancel={() => setShowExpenseForm(false)}
                            />
                        )}

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {expenses.map(expense => (
                                <ExpenseCard 
                                    key={expense.id}
                                    expense={expense}
                                    onDelete={(id) => {
                                        if (!defaultExpenses.find(d => d.id === id)) {
                                            setExpenses(expenses.filter(e => e.id !== id));
                                        } else {
                                            alert('Impossible de supprimer une d√©pense par d√©faut');
                                        }
                                    }}
                                    isDefault={defaultExpenses.find(d => d.id === expense.id)}
                                />
                            ))}
                        </div>
                    </div>
                </div>
            );
        }

        // Formulaire d√©pense
        function ExpenseForm({ onSave, onCancel }) {
            const [expense, setExpense] = useState({
                description: '',
                amount: 0,
                frequency: 'monthly',
                startDate: new Date().toISOString().split('T')[0]
            });

            return (
                <div className="card p-6 mb-6">
                    <h4 className="font-bold text-arkelis-blue mb-4">Nouvelle d√©pense</h4>
                    
                    <div className="grid grid-cols-2 gap-4 mb-4">
                        <input
                            type="text"
                            placeholder="Description"
                            value={expense.description}
                            onChange={(e) => setExpense({...expense, description: e.target.value})}
                            className="w-full col-span-2"
                        />
                        <input
                            type="number"
                            placeholder="Montant HT"
                            value={expense.amount}
                            onChange={(e) => setExpense({...expense, amount: parseFloat(e.target.value) || 0})}
                            className="w-full"
                            min="0"
                            step="0.01"
                        />
                        <select
                            value={expense.frequency}
                            onChange={(e) => setExpense({...expense, frequency: e.target.value})}
                            className="w-full"
                        >
                            <option value="monthly">Mensuel</option>
                            <option value="yearly">Annuel</option>
                            <option value="unique">Unique</option>
                        </select>
                        <input
                            type="date"
                            value={expense.startDate}
                            onChange={(e) => setExpense({...expense, startDate: e.target.value})}
                            className="w-full col-span-2"
                        />
                    </div>

                    <div className="flex gap-3">
                        <button 
                            onClick={() => {
                                if (!expense.description || expense.amount <= 0) {
                                    alert('Veuillez remplir tous les champs');
                                    return;
                                }
                                onSave(expense);
                            }}
                            className="btn btn-primary flex-1"
                        >
                            Ajouter la d√©pense
                        </button>
                        <button onClick={onCancel} className="btn bg-gray-200 text-gray-700">
                            Annuler
                        </button>
                    </div>
                </div>
            );
        }

        // Carte d√©pense
        function ExpenseCard({ expense, onDelete, isDefault }) {
            const getFrequencyLabel = (freq) => {
                switch(freq) {
                    case 'monthly': return 'Mensuel';
                    case 'yearly': return 'Annuel';
                    case 'unique': return 'Unique';
                    default: return freq;
                }
            };

            const formatDate = (dateString) => {
                const date = new Date(dateString);
                return date.toLocaleDateString('fr-FR', { month: 'short', year: 'numeric' });
            };

            return (
                <div className="card p-4 flex justify-between items-center">
                    <div className="flex-1">
                        <div className="flex items-center gap-2">
                            <h4 className="font-semibold text-arkelis-blue">{expense.description}</h4>
                            {isDefault && (
                                <span className="badge badge-yearly text-xs">D√©faut</span>
                            )}
                        </div>
                        <p className="text-sm text-gray-500">
                            Depuis {formatDate(expense.startDate)}
                        </p>
                    </div>
                    <div className="text-right">
                        <p className="text-xl font-bold text-red-600">{expense.amount.toFixed(2)} ‚Ç¨ HT</p>
                        <span className={`badge ${
                            expense.frequency === 'monthly' ? 'badge-monthly' :
                            expense.frequency === 'yearly' ? 'badge-yearly' : 'badge-unique'
                        }`}>
                            {getFrequencyLabel(expense.frequency)}
                        </span>
                    </div>
                    {!isDefault && (
                        <button 
                            onClick={() => {
                                if (confirm('Supprimer cette d√©pense ?')) {
                                    onDelete(expense.id);
                                }
                            }}
                            className="ml-4 text-red-500 hover:text-red-700"
                        >
                            ‚úï
                        </button>
                    )}
                </div>
            );
        }

        // Rendu
        ReactDOM.render(<ArkelisApp />, document.getElementById('root'));
    </script>
</body>
</html>
